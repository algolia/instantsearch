name: Documentation Automation

on:
  # Trigger on push to master (for release commits)
  push:
    branches:
      - master

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      run_claude:
        description: 'Run Claude Code'
        default: false
        type: boolean
      create_pr:
        description: 'Create PR'
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    # Only run on release commits or manual triggers
    if: github.event_name == 'workflow_dispatch' || startsWith(github.event.head_commit.message, 'chore: release')
    outputs:
      has_docs_changes: ${{ steps.generate-prompt.outputs.has_docs_changes }}
      packages_json: ${{ steps.generate-prompt.outputs.packages_json }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: |
          cd scripts/docs-automation
          yarn install

      - name: Generate Claude prompt
        id: generate-prompt
        run: |
          cd scripts/docs-automation

          # Auto-detect all released packages and generate combined prompt
          npx tsx src/index.ts generate-prompt --output ./prompt.txt --verbose

          # Check if prompt was generated (packages with doc needs found)
          if [[ -f ./prompt.txt ]]; then
            echo "has_docs_changes=true" >> $GITHUB_OUTPUT

            # Read packages info JSON and encode for output
            if [[ -f ./prompt-packages.json ]]; then
              PACKAGES_JSON=$(cat ./prompt-packages.json | base64 -w 0)
              echo "packages_json=$PACKAGES_JSON" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_docs_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload prompt artifact
        if: steps.generate-prompt.outputs.has_docs_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: claude-prompt
          path: |
            scripts/docs-automation/prompt.txt
            scripts/docs-automation/prompt-packages.json
          retention-days: 7

  update-docs:
    name: Update Documentation
    needs: detect-changes
    if: needs.detect-changes.outputs.has_docs_changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout instantsearch (for source reference)
        uses: actions/checkout@v4
        with:
          path: instantsearch

      - name: Download prompt
        uses: actions/download-artifact@v4
        with:
          name: claude-prompt
          path: ./

      - name: Clone docs-new repository
        run: |
          git clone https://x-access-token:${{ secrets.DOCS_REPO_PAT }}@github.com/algolia/docs-new.git docs-new
          cd docs-new
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Show prompt (dry run)
        if: github.event_name == 'workflow_dispatch' && inputs.run_claude == false
        run: |
          echo "## Generated Prompt"
          echo ""
          cat prompt.txt
          echo ""
          echo "---"
          echo "## Packages Info"
          cat prompt-packages.json || echo "No packages info"
          echo ""
          echo "---"
          echo "To run Claude, trigger the workflow with run_claude=true"

      - name: Run Claude Code
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_claude == true)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        working-directory: docs-new
        run: |
          # Read the prompt and add reference to instantsearch source
          PROMPT=$(cat ../prompt.txt)
          PROMPT="$PROMPT

          ## Source Code Reference

          The instantsearch source code is available at ../instantsearch for reference.
          You can read files from there to understand the API, types, and implementation details.
          For example: ../instantsearch/packages/instantsearch.js/src/widgets/
          "

          # Run Claude Code in headless mode
          claude -p "$PROMPT" \
            --allowedTools "Read,Edit,Write,Bash(git diff *),Bash(git status *),Glob,Grep" \
            --output-format text

      - name: Install docs-new dependencies
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_claude == true)
        working-directory: docs-new
        run: npm ci

      - name: Run style guide check
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_claude == true)
        working-directory: docs-new
        continue-on-error: true
        run: npm run check:styleguide || echo "Style guide check not available or failed"

      - name: Run link check
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_claude == true)
        working-directory: docs-new
        continue-on-error: true
        run: npm run check:links || echo "Link check not available or failed"

      - name: Show changes (no PR)
        if: github.event_name == 'workflow_dispatch' && inputs.run_claude == true && inputs.create_pr == false
        working-directory: docs-new
        run: |
          echo "## Changes made by Claude"
          echo ""
          git status
          echo ""
          git diff || true
          echo ""
          echo "---"
          echo "To create a PR, trigger the workflow with create_pr=true"

      - name: Create branch and commit
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.create_pr == true)
        working-directory: docs-new
        run: |
          DATE=$(date +%Y%m%d)
          BRANCH="docs/release-${DATE}"

          # Check if there are changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Create branch and commit
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "docs: update documentation for release

          Auto-generated by InstantSearch docs automation.

          Co-Authored-By: Claude <noreply@anthropic.com>"

          # Push branch
          git push origin "$BRANCH"

          echo "branch=$BRANCH" >> $GITHUB_ENV

      - name: Create Pull Request
        if: env.branch != '' && (github.event_name == 'push' || inputs.create_pr == true)
        env:
          GITHUB_TOKEN: ${{ secrets.DOCS_REPO_PAT }}
        working-directory: docs-new
        run: |
          # Parse packages info for PR body
          PACKAGES_LIST=""
          if [[ -f ../prompt-packages.json ]]; then
            PACKAGES_LIST=$(cat ../prompt-packages.json | jq -r '.[] | "- \(.name)@\(.version) (\(.priority) priority)"' 2>/dev/null || echo "")
          fi

          gh pr create \
            --repo algolia/docs-new \
            --title "docs: update documentation for release" \
            --body "## Summary

          Auto-generated documentation update for InstantSearch release.

          ## Packages Included

          ${PACKAGES_LIST:-No package info available}

          ## Source
          - [Release workflow](https://github.com/algolia/instantsearch/actions/runs/${{ github.run_id }})

          ## Review Checklist
          - [ ] Content is accurate and complete
          - [ ] Code examples work correctly
          - [ ] Links are valid
          - [ ] Formatting follows documentation style guide

          ---
          *Generated by [InstantSearch Docs Automation](https://github.com/algolia/instantsearch)*" \
            --draft \
            --label "documentation" \
            --label "auto-generated"

      - name: Summary
        run: |
          echo "## Documentation Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ -f prompt-packages.json ]]; then
            echo "### Packages Detected" >> $GITHUB_STEP_SUMMARY
            cat prompt-packages.json | jq -r '.[] | "- **\(.name)** v\(.version) (\(.priority) priority)"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "- Unable to parse packages" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "### Manual Run Settings" >> $GITHUB_STEP_SUMMARY
            echo "- **Run Claude:** ${{ inputs.run_claude }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Create PR:** ${{ inputs.create_pr }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ -n "${{ env.branch }}" ]]; then
            echo "### Result" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** ${{ env.branch }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A draft PR has been created in algolia/docs-new." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.run_claude }}" == "false" ]]; then
            echo "**Dry run mode.** Only the prompt was generated. Check the logs to see it." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.create_pr }}" == "false" ]]; then
            echo "**Preview mode.** Claude ran but no PR was created. Check the logs to see changes." >> $GITHUB_STEP_SUMMARY
          fi
